# do a small safety to insure the directory is there:
$temp_folder = "C:\Temp\consul-temp"
if (!(Test-Path "$temp_folder")) {
    mkdir $temp_folder
}

## download the agent:
$download_url = "<%= scope['$consul::real_download_url'] %>"
$download_filename = $download_url.Substring($download_url.LastIndexOf("/") + 1)
(New-Object Net.WebClient).DownloadFile("$download_url","$temp_folder/$download_filename")

# do a small safety to insure the directory is there:
$bin_folder = "<%= scope['$consul::bin_dir'] %>"  -replace "/", "\"
if (!(Test-Path "$bin_folder")) {
    mkdir $bin_folder
}

$download_file = $temp_folder + "\" + $download_filename

# unpack the critter:
function Expand-me($file, $destination) {
  $shell = new-object -com shell.application
  $zip = $shell.NameSpace($file)
  foreach($item in $zip.items()) {
      $shell.Namespace($destination).copyhere($item)
  }
}

Expand-me -File $download_file -Destination $bin_folder
